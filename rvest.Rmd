# rvestでスクレイピング {#rvest}

## スクレイピング

ここでのスクレイピングとは，ウェブスクレイピングの省略のことで，ウェブサイトにある情報を収集することである．
ウェブサイトから植生調査データを収集することはほとんどないものの，関連データの収集は可能である．
例えば，気象庁のページから気象データが収集可能である．
もちろん，気象データは手動でも収集可能ではあるが，多大な手間と長い時間が必要である．
研究に必要なデータを自動で取得できれば，手間と時間の節約が可能である．

そこで，本稿ではウェブでの情報収集の方法を紹介することを目的とする．
世界の各地点の気象データをプロット
情報収集にはRのパッケージであるrvestを用いる．
rvestを用いて気象庁のページから世界の気象データを入手して，気候ダイアグラムを描画する．


Rのパッケージ作成では，rvestを用いて作成した関数と収集したデータをまとめたパッケージの作成方法を紹介する．
著者自身，他人のためにパッケージをつくることは考えておらず，基本的には自分の研究や作業のための関数をまとめることを目的としてパッケージをいくつか作成した．
作成したら，ついでに他人にも使ってもらえれば嬉しいという程度である．

過去に作成した関数は，しばらくすると関数の引数や返り値がどのようなものであったのか忘れてしまいがちである．
パッケージをつくる(特にCRANに登録する)には，引数，返り値，使用例などをまとめる必要がある．
きっちりまとめなくても良いのではあるが，決まった形式の方がむしろまとめやすい．
また，RStudioとusethis, testthat, devtoolsなどのパッケージを使ってパッケージ開発すると，各種チェックやテストが可能である．
各種チェックやテストでたくさんのエラーを見ると，チェックやテストは正直なところ煩わしいと感じる．
特に，パケージ開発に慣れていないと特にそうである．
しかし，チェックやテストをすることで，関数の完成度を確実に高めることができるため，パッケージとしてまとめる利点である．


## rvest と RSelenium

スクレイピングをするために使われる主なRのパッケージとしては，rvestとRSeleniumがある．
rvestは，静的なサイトを対象とするときに役立つ．
つまり，URLを指定すれば対象のサイトのページが決まるときである．
気象庁での気象データを提供しているページがこれに当たる．
一方，RSeleniumは動的なサイトを対象とするときに役立つ．
例えば，テキストボックスへのデータ入力やプルダウンメニューの選択あるいはその後のマウス操作でページが遷移する場合である．
このような動的なサイトでは，Seleniumだけでなく，Javascriptを部分的に用いるのも効果的である．
なお，rvestでもユーザ名とパスワードを用いた一般的なログインは可能である．
また，politeパッケージと組み合わせることである程度の動的なサイトのスクレイピングは可能である．

<!--
CRANには，植生データの取得のためのパッケージがある．
  # 本当?
  # 海外のもの
しかし，自分のもとめるデータがあるとは限らない．
特に日本のデータの取得は少ない．

--> 

## rvestのできること

- HTMLの取得    
- DOMの取得: id, class, tagNameなどを用いる   
- tableの取得    
  - HTML内の取得したいデータはtableにあることが多いため，非常に便利
  そもそも，tableでないデータを取得するのは非常に不便
- リンクの取得  
ページ遷移に使用する   
- stringrと組み合わせて使うと良い   
- 文字コードの変換にはstringiを用いる   
- tidyverseやmagrittrとの合せ技が便利    
- Formの入力・選択
radioボタンはちょっと工夫が必要
moranajp::html_radio_set()
無理やりな感じではあるが，同一名称のradioボタンを全て同じ値に変更する
本来なら，不要なradioボタンのフォームを削除
  可能だが，インデクスがずれるので結構厄介
politeパッケージとの連携

## 準備

```{r}
  # install.packages("rvest")
  # library(rvest)

library(tidyverse)
library(rvest)
Sys.setlocale("LC_TIME", "en_US.UTF-8") # アメリカ英語に設定
date <- today()
date <- date - years(1)
ym <- paste0("^", year(date), "年", month(date) , "月")

main <- "https://www.aboutamazon.jp/news/entertainment/amazon-prime-video-new-content-"
url <- 
  month(date, label = TRUE, abbr = FALSE) %>%
  stringr::str_to_lower() %>%
  paste0(main, ., "-", year(date)
html <- rvest::read_html(url)
contents <- 
  html %>%
  rvest::html_elements("body") %>%
  rvest::html_elements("div.RichTextArticleBody-body li,p,h3.cms-headings-h3") %>%
  rvest::html_text() %>%
  tibble::as_tibble() %>%
  dplyr::filter(value != "")

contents %>%
  dplyr::mutate(
    div = dplyr::case_when(
      stringr::str_detect(value, "^洋画|邦画|アニメ|海外|国内|韓国") & stringr::str_length(value) < 20 ~ value,
      TRUE ~ NA    )) %>%
  dplyr::mutate(
    date = dplyr::case_when(
      stringr::str_detect(value, ym) ~ value,
      TRUE ~ NA    )) %>%
  tidyr::fill(div,  .direction = "down") %>%
  tidyr::fill(date, .direction = "down") %>%
  dplyr::mutate(value = stringr::str_sub(value, 1,15)) %>%
  print(n=100)

  #   html_elements("h3.cms-headings-h3") %>%

  # id         rvest::html_elements("#content") %>%
  # class      rvest::html_elements(".next") %>%
  # tag        rvest::html_elements("a") %>%
  # 属性       rvest::html_attr("href")

```


## HTMLの取得

### 使い方

```{r}
```

### 注意点


## DOMの取得



### 使い方

```{r}
```

### 注意点
